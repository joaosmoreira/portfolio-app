---
import Layout from "../layouts/Layout.astro";
import {
    ArrowLeft,
    Activity,
    Info,
    AlertTriangle,
    CheckCircle2,
    RefreshCw,
} from "lucide-react";

// The frontend UI for the Financial Intelligence & Risk Engine (FIRE)
// Uses lightweight-charts for the raw price data and renders the AI Context analysis aside.
---

<Layout title="FIRE: Risk Engine & AI Sentiment | João Moreira" theme="dark">
    <div class="max-w-6xl mx-auto w-full font-['Inter']">
        <header class="mb-8 pb-6 border-b border-zinc-800">
            <!-- (keep existing header) -->
            <div class="flex items-center gap-4 mb-4">
                <a
                    href="/portfolio"
                    class="text-zinc-500 hover:text-white transition-colors"
                >
                    <ArrowLeft className="w-5 h-5" />
                </a>
                <h1
                    class="text-4xl font-bold tracking-tight text-white mb-0 flex items-center gap-3"
                >
                    F.I.R.E. <span
                        class="text-xs font-mono px-2 py-1 rounded bg-zinc-800 text-zinc-300"
                        >Risk Engine</span
                    >
                </h1>
            </div>
            <p class="text-zinc-400 max-w-2xl text-lg">
                Sistema de análise de risco multidimensional e processamento de
                contexto social governado por IA.
            </p>
        </header>

        <!-- Watchlist -->
        <div class="mb-10">
            <h2
                class="text-xs font-mono text-zinc-500 uppercase tracking-widest mb-4"
            >
                Radar Global (Live)
            </h2>
            <div
                id="watchlist-grid"
                class="grid grid-cols-2 lg:grid-cols-5 gap-4"
            >
                <!-- Populated via JS -->
            </div>
        </div>

        <div class="mb-8 flex flex-col md:flex-row gap-4 items-end">
            <div class="w-full md:w-64">
                <label
                    class="block text-xs font-mono text-zinc-500 uppercase tracking-widest mb-2"
                    >Ativo (Yahoo Finance)</label
                >
                <input
                    type="text"
                    id="symbol-input"
                    value="BTC-USD"
                    class="w-full bg-[#0d0d10] border border-zinc-800 text-white px-4 py-3 rounded focus:outline-none focus:border-zinc-500 transition-colors font-medium"
                />
            </div>
            <button
                id="analyze-btn"
                class="w-full md:w-auto px-8 py-3 bg-white text-black font-semibold rounded hover:bg-zinc-200 transition-colors flex items-center justify-center gap-2"
            >
                <Activity className="w-5 h-5" />
                Analisar Contexto
            </button>
        </div>

        <!-- Loading State -->
        <div
            id="loading-state"
            class="hidden py-24 flex-col items-center justify-center text-zinc-500"
        >
            <RefreshCw className="w-8 h-8 animate-spin mb-4 text-zinc-400" />
            <p class="font-mono text-sm tracking-wider uppercase">
                Processando Risk Engine & AI...
            </p>
        </div>

        <!-- Error State -->
        <div
            id="error-state"
            class="hidden p-6 bg-red-950/20 border border-red-900/50 rounded-lg text-red-500 items-start gap-4 mb-8"
        >
            <AlertTriangle className="w-6 h-6 shrink-0 mt-0.5" />
            <div>
                <h3 class="font-semibold text-red-400 mb-1">Erro na Análise</h3>
                <p id="error-msg" class="text-sm opacity-80">
                    Não foi possível obter dados.
                </p>
            </div>
        </div>

        <!-- Results (Hidden initially) -->
        <div
            id="results-container"
            class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8"
        >
            <!-- Left Column: Chart -->
            <div class="lg:col-span-2 space-y-6">
                <div
                    class="p-1 rounded-xl bg-zinc-900 border border-zinc-800 ring-1 ring-white/5 shadow-2xl overflow-hidden relative"
                >
                    <div class="absolute top-4 left-6 z-10 pointer-events-none">
                        <h2
                            id="chart-title"
                            class="text-2xl font-bold text-white tracking-tight drop-shadow-md"
                        >
                            BTC-USD
                        </h2>
                        <div
                            class="flex items-baseline gap-2 mt-1 drop-shadow-md"
                        >
                            <span
                                id="chart-price"
                                class="text-xl font-medium text-zinc-300"
                                >Carregando...</span
                            >
                            <span
                                id="chart-change"
                                class="text-sm font-semibold">--</span
                            >
                        </div>
                    </div>
                    <!-- The Chart Container -->
                    <div
                        id="tv-chart"
                        class="w-full h-[450px] rounded-lg overflow-hidden bg-[#13151a]"
                    >
                    </div>
                </div>

                <p class="text-xs text-zinc-500 flex items-center gap-2">
                    <Info className="w-4 h-4" />
                    O gráfico (O Quê) exibe a ação do preço e sinais automáticos
                    baseados no algoritmo técnico.
                </p>
            </div>

            <!-- Right Column: AI & Risk Context -->
            <div class="space-y-6">
                <!-- Risk Card -->
                <div
                    class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 relative overflow-hidden"
                >
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-white/5 blur-3xl rounded-full translate-x-1/2 -translate-y-1/2"
                    >
                    </div>

                    <h3
                        class="text-xs font-mono text-zinc-500 uppercase tracking-widest mb-6"
                    >
                        Risk Algorithm
                    </h3>

                    <div class="flex items-end gap-4 mb-6">
                        <div
                            class="text-5xl font-black tracking-tighter text-white"
                            id="risk-score"
                        >
                            --
                        </div>
                        <div
                            class="mb-1 text-sm font-medium px-2.5 py-1 rounded"
                            id="risk-badge"
                        >
                            --
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div
                            class="text-xs font-semibold text-zinc-400 uppercase tracking-wider"
                        >
                            Métricas Activas
                        </div>
                        <ul
                            id="risk-metrics"
                            class="space-y-2 text-sm text-zinc-300"
                        >
                            <!-- Populated via JS -->
                        </ul>
                    </div>
                </div>

                <!-- AI Sentiment Card -->
                <div
                    class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 relative overflow-hidden ring-1 ring-white/5 shadow-xl"
                >
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 blur-3xl rounded-full translate-x-1/2 -translate-y-1/2"
                    >
                    </div>

                    <div class="flex items-center justify-between mb-6">
                        <h3
                            class="text-xs font-mono text-zinc-500 uppercase tracking-widest flex items-center gap-2"
                        >
                            X Intelligence
                        </h3>
                        <span
                            class="text-[10px] bg-blue-500/10 text-blue-400 border border-blue-500/20 px-2 py-0.5 rounded uppercase font-mono tracking-wider"
                            >AI Powered</span
                        >
                    </div>

                    <div class="space-y-5">
                        <div>
                            <div
                                class="text-[11px] text-zinc-500 mb-1 font-medium"
                            >
                                Sentimento Consenso
                            </div>
                            <div
                                id="ai-sentiment"
                                class="text-lg font-semibold text-white"
                            >
                                --
                            </div>
                        </div>

                        <div class="h-px w-full bg-zinc-800/50"></div>

                        <div>
                            <div
                                class="text-[11px] text-zinc-500 mb-1.5 font-medium"
                            >
                                Sumário de Traders (X/Twitter)
                            </div>
                            <p
                                id="ai-summary"
                                class="text-sm text-zinc-300 leading-relaxed"
                            >
                                --
                            </p>
                        </div>

                        <div
                            class="p-3 bg-black/30 rounded border border-zinc-800/50 mt-2"
                        >
                            <div
                                class="text-[11px] text-zinc-500 mb-1 font-medium flex items-center gap-1.5"
                            >
                                <AlertTriangle
                                    className="w-3 h-3 text-yellow-500"
                                /> Driver Fundamental
                            </div>
                            <p
                                id="ai-driver"
                                class="text-xs text-zinc-400 italic"
                            >
                                --
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { createChart, CrosshairMode } from "lightweight-charts";

    let chart: any = null;
    let lineSeries: any = null;

    function initChart() {
        if (chart) return;

        const container = document.getElementById("tv-chart");
        if (!container) return;

        chart = createChart(container, {
            layout: {
                background: { type: "solid" as any, color: "#13151a" },
                textColor: "#71717a", // zinc-500
            },
            grid: {
                vertLines: { color: "rgba(255, 255, 255, 0.05)" },
                horzLines: { color: "rgba(255, 255, 255, 0.05)" },
            },
            crosshair: {
                mode: CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: "rgba(255, 255, 255, 0.1)",
            },
            timeScale: {
                borderColor: "rgba(255, 255, 255, 0.1)",
            },
        });

        lineSeries = chart.addLineSeries({
            color: "#a1a1aa", // zinc-400
            lineWidth: 2,
            crosshairMarkerVisible: true,
            crosshairMarkerRadius: 4,
            crosshairMarkerBorderColor: "#fff",
            crosshairMarkerBackgroundColor: "#18181b", // zinc-900
        });

        // Resize observer to make chart responsive
        new ResizeObserver((entries) => {
            if (entries.length === 0 || entries[0].target !== container) {
                return;
            }
            const newRect = entries[0].contentRect;
            chart.applyOptions({
                height: newRect.height,
                width: newRect.width,
            });
        }).observe(container);
    }

    async function analyzeContext() {
        const symbol =
            (document.getElementById("symbol-input") as HTMLInputElement)
                .value || "BTC-USD";
        const analyzeBtn = document.getElementById(
            "analyze-btn"
        ) as HTMLButtonElement;
        const loadingState = document.getElementById("loading-state");
        const errorState = document.getElementById("error-state");
        const resultsContainer = document.getElementById("results-container");

        // UI Reset
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = "Processando...";
        resultsContainer?.classList.add("hidden");
        errorState?.classList.add("hidden");
        loadingState?.classList.remove("hidden");
        loadingState?.classList.add("flex");

        try {
            const res = await fetch("/api/fire-analyze", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ symbol }),
            });
            const payload = await res.json();

            if (!res.ok || !payload.success)
                throw new Error(payload.error || "Failed to analyze");

            const { data } = payload;

            // 1. Chart Data
            initChart();
            lineSeries.setData(data.chartData);
            if (data.markers && data.markers.length > 0) {
                lineSeries.setMarkers(data.markers);
            }
            chart.timeScale().fitContent();

            // 2. Headings
            (
                document.getElementById("chart-title") as HTMLElement
            ).textContent = data.symbol.toUpperCase();
            (
                document.getElementById("chart-price") as HTMLElement
            ).textContent = `$${data.currentPrice.toFixed(2)}`;

            const changeEl = document.getElementById(
                "chart-change"
            ) as HTMLElement;
            const changeNum = parseFloat(data.change24h);
            changeEl.textContent = `${
                changeNum > 0 ? "+" : ""
            }${changeNum.toFixed(2)}%`;
            changeEl.className = `text-sm font-semibold ${
                changeNum > 0 ? "text-green-500" : "text-red-500"
            }`;

            // 3. Risk Algorithm
            (document.getElementById("risk-score") as HTMLElement).textContent =
                data.risk.score;

            const badge = document.getElementById("risk-badge") as HTMLElement;
            badge.textContent = data.risk.category;
            badge.className = `mb-1 text-sm font-medium px-2.5 py-1 rounded border ${
                data.risk.category === "Baixo"
                    ? "bg-green-500/10 text-green-400 border-green-500/20"
                    : data.risk.category === "Elevado"
                    ? "bg-red-500/10 text-red-400 border-red-500/20"
                    : "bg-yellow-500/10 text-yellow-400 border-yellow-500/20"
            }`;

            const metricsList = document.getElementById(
                "risk-metrics"
            ) as HTMLElement;
            metricsList.innerHTML = data.risk.metrics
                .map(
                    (m: string) =>
                        `<li class="flex items-center gap-2"><svg class="w-4 h-4 text-zinc-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> ${m}</li>`
                )
                .join("");

            // 4. AI Context
            (
                document.getElementById("ai-sentiment") as HTMLElement
            ).textContent = data.aiContext.sentiment;
            (document.getElementById("ai-summary") as HTMLElement).textContent =
                data.aiContext.consensusSummarization;
            (document.getElementById("ai-driver") as HTMLElement).textContent =
                data.aiContext.fundamentalDriver;

            // Show results
            loadingState?.classList.add("hidden");
            loadingState?.classList.remove("flex");
            resultsContainer?.classList.remove("hidden");
        } catch (err: unknown) {
            console.error(err);
            errorState?.classList.remove("hidden");
            errorState?.classList.add("flex");
            const msgEl = document.getElementById("error-msg");
            if (msgEl)
                msgEl.textContent =
                    err instanceof Error ? err.message : "Um erro ocorreu.";
            loadingState?.classList.add("hidden");
            loadingState?.classList.remove("flex");
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg> Analisar Contexto`;
        }
    }

    // Attach to button
    document
        .getElementById("analyze-btn")
        ?.addEventListener("click", analyzeContext);

    // Also trigger on pressing enter in input
    document
        .getElementById("symbol-input")
        ?.addEventListener("keypress", (e) => {
            if (e.key === "Enter") analyzeContext();
        });

    // Watchlist Logic
    const watchlistSymbols = ["BTC-USD", "ETH-USD", "AAPL", "NVDA", "EURUSD=X"];

    async function initWatchlist() {
        const container = document.getElementById("watchlist-grid");
        if (!container) return;

        for (const sym of watchlistSymbols) {
            const card = document.createElement("div");
            card.className =
                "relative overflow-hidden p-4 bg-zinc-900 border border-zinc-800 rounded-xl cursor-pointer hover:border-zinc-600 transition-colors flex flex-col justify-between h-28";
            card.innerHTML = `<div class="flex justify-between items-start"><span class="font-bold text-white text-sm">${sym}</span><span class="text-xs text-zinc-500 animate-pulse">loading...</span></div>`;
            container.appendChild(card);

            try {
                const res = await fetch("/api/fire-analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ symbol: sym, basic: true }),
                });
                const payload = await res.json();
                if (payload.success) {
                    const { currentPrice, change24h, chartData } = payload.data;
                    const changeNum = parseFloat(change24h);
                    const isUp = changeNum > 0;

                    card.innerHTML = `
                        <div class="flex justify-between items-start z-10 relative">
                            <span class="font-bold text-white text-sm">${sym}</span>
                            <span class="text-xs font-semibold ${
                                isUp ? "text-green-500" : "text-red-500"
                            }">${isUp ? "+" : ""}${changeNum.toFixed(2)}%</span>
                        </div>
                        <div class="text-zinc-300 text-sm font-medium z-10 relative">$${currentPrice.toFixed(
                            2
                        )}</div>
                        <div class="absolute inset-0 pt-10 opacity-40 pointer-events-none mini-chart-container"></div>
                    `;
                    card.onclick = () => {
                        (
                            document.getElementById(
                                "symbol-input"
                            ) as HTMLInputElement
                        ).value = sym;
                        analyzeContext();
                        window.scrollTo({
                            top:
                                document.getElementById("symbol-input")
                                    ?.offsetTop || 0 - 100,
                            behavior: "smooth",
                        });
                    };

                    const chartContainer = card.querySelector(
                        ".mini-chart-container"
                    ) as HTMLElement;
                    const mChart = createChart(chartContainer, {
                        layout: {
                            background: {
                                type: "solid" as any,
                                color: "transparent",
                            },
                            textColor: "transparent",
                        },
                        grid: {
                            vertLines: { visible: false },
                            horzLines: { visible: false },
                        },
                        timeScale: { visible: false },
                        rightPriceScale: { visible: false },
                        handleScroll: false,
                        handleScale: false,
                        crosshair: { mode: 2 },
                    });
                    const mSeries = mChart.addLineSeries({
                        color: isUp ? "#22c55e" : "#ef4444",
                        lineWidth: 2,
                        crosshairMarkerVisible: false,
                        priceLineVisible: false,
                    });
                    mSeries.setData(chartData);
                    mChart.timeScale().fitContent();
                } else {
                    card.innerHTML = `<div class="flex justify-between items-start"><span class="font-bold text-white text-sm">${sym}</span><span class="text-xs text-red-500">Error</span></div>`;
                }
            } catch (e) {
                card.innerHTML = `<div class="flex justify-between items-start"><span class="font-bold text-white text-sm">${sym}</span><span class="text-xs text-red-500">Failed</span></div>`;
            }
        }
    }

    initWatchlist();
</script>
